# minio

https://cloud.tencent.com/developer/article/1674380

https://github.com/minio/minio-java/tree/release/examples

## 调试

https://github.com/minio/minio/tree/master/docs/debugging

```yml
version: '3.7'

# Settings and configurations that are common for all containers
x-minio-common: &minio-common
  image: quay.io/minio/minio:RELEASE.2021-12-10T23-03-39Z
  command: server --console-address ":9001" http://minio{1...4}/data{1...2}
  expose:
    - "9000"
    - "9001"
  environment:
    MINIO_ROOT_USER: minio
    MINIO_ROOT_PASSWORD: minio123
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
    interval: 30s
    timeout: 20s
    retries: 3

# starts 4 docker containers running minio server instances.
# using nginx reverse proxy, load balancing, you can access
# it through port 9000.
services:
  minio1:
    <<: *minio-common
    hostname: minio1
    volumes:
      - data1-1:/data1
      - data1-2:/data2

  minio2:
    <<: *minio-common
    hostname: minio2
    volumes:
      - data2-1:/data1
      - data2-2:/data2

  minio3:
    <<: *minio-common
    hostname: minio3
    volumes:
      - data3-1:/data1
      - data3-2:/data2

  minio4:
    <<: *minio-common
    hostname: minio4
    volumes:
      - data4-1:/data1
      - data4-2:/data2

  nginx:
    image: nginx:1.19.2-alpine
    hostname: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "9000:9000"
      - "9001:9001"
    depends_on:
      - minio1
      - minio2
      - minio3
      - minio4

## By default this config uses default local driver,
## For custom volumes replace with volume driver configuration.
volumes:
  data1-1:
  data1-2:
  data2-1:
  data2-2:
  data3-1:
  data3-2:
  data4-1:
  data4-2:
```

```sh
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  4096;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;

    # include /etc/nginx/conf.d/*.conf;

    upstream minio {
        server minio1:9000;
        server minio2:9000;
        server minio3:9000;
        server minio4:9000;
    }

    upstream console {
        ip_hash;
        server minio1:9001;
        server minio2:9001;
        server minio3:9001;
        server minio4:9001;
    }

    server {
        listen       9000;
        listen  [::]:9000;
        server_name  localhost;

        # To allow special characters in headers
        ignore_invalid_headers off;
        # Allow any size file to be uploaded.
        # Set to a value such as 1000m; to restrict file size to a specific value
        client_max_body_size 0;
        # To disable buffering
        proxy_buffering off;

        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 300;
            # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;

            proxy_pass http://minio;
        }
    }

    server {
        listen       9001;
        listen  [::]:9001;
        server_name  localhost;

        # To allow special characters in headers
        ignore_invalid_headers off;
        # Allow any size file to be uploaded.
        # Set to a value such as 1000m; to restrict file size to a specific value
        client_max_body_size 1000m;
        # To disable buffering
        proxy_buffering off;

        location / {
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-NginX-Proxy true;

            # This is necessary to pass the correct IP to be hashed
            real_ip_header X-Real-IP;

            proxy_connect_timeout 300;

            # To support websocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            chunked_transfer_encoding off;

            proxy_pass http://console;
        }
    }
}

```

https://raw.githubusercontent.com/minio/minio/master/docs/orchestration/docker-compose/docker-compose.yaml

http://docs.minio.org.cn/docs/master/minio-client-quickstart-guide

# mc客户端

```sh
PS> Invoke-WebRequest -Uri "https://dl.minio.io/client/mc/release/windows-amd64/mc.exe" -OutFile "C:\mc.exe"
C:\mc.exe alias set myminio/ http://MINIO-SERVER MYUSER MYPASSWORD
```

https://docs.min.io/minio/baremetal/reference/minio-cli/minio-mc/mc-share.html

https://min.io/download

# minio 源码分析

https://fengmeng.xyz/p/go-minio/

# minio报错

```sh
Exception in thread "main" io.minio.errors.InvalidResponseException: Non-XML response from server. Response code: 403, Content-Type: text/xml; charset=utf-8, body: <?xml version="1.0" encoding="UTF-8"?>
<Error>
  <Code>AccessDenied</Code>
  <Message>S3 API Request made to Console port. S3 Requests should be sent to API port.</Message>
  <RequestId>0</RequestId>
</Error>

	at io.minio.MinioClient.execute(MinioClient.java:681)
	at io.minio.MinioClient.getRegion(MinioClient.java:807)
	at io.minio.MinioClient.execute(MinioClient.java:567)
	at io.minio.MinioClient.executeHead(MinioClient.java:839)
	at io.minio.MinioClient.bucketExists(MinioClient.java:2204)
	at MinioUtil.upload(MinioUtil.java:194)
	at FileUtil.main(FileUtil.java:27)
```

spring 配置上传文件大小限制
nginx配置上传文件大小限制
```sh
spring.servlet.multipart.maxFileSize=50MB
spring.servlet.multipart.maxRequestSize=100MB
# nginx.conf
client_max_body_size 1000M;
```

API的端口是9000

https://blog.csdn.net/Jake_955/article/details/116205270


https://blog.csdn.net/weixin_41352552/article/details/121094971


# 权限认证报错

```sh
{
    "Statement": [
        {
        "Action": [
            "s3:GetBucketLocation",
            "s3:ListBucket",
            "s3:ListBucketMultipartUploads"
        ],
        "Effect": "Allow",
        "Principal": {
            "AWS": "*"
        },
        "Resource": "arn:aws:s3::::turing",
        "Sid": ""
        },
        {
        "Action": [
            "s3:AbortMultipartUpload",
            "s3:DeleteObject",
            "s3:GetObject",
            "s3:ListMultipartUploadParts",
            "s3:PutObject"
        ],
        "Effect": "Allow",
        "Principal": {
        "AWS": "*"
        },
        "Resource": "arn:aws:s3::::turing/*",
        "Sid": ""
        }
    ],
    "Version": "2021-12-14"
}
```

https://stackoverflow.com/questions/35189663/s3-invalid-resource-in-bucket-policy

# 分享


创建有永久下载权限的minio 存储

```sh
# list default hosts after install:
mc config host ls

# remove all hosts: mc config host rm {hostName}
mc config host rm local

# add your host: mc config host add {hostName} {url} {apiKey} {apiSecret}
mc config host add local http://127.0.01:9000 ClientIdxx ClientSecretxxx

# create bucket: mc mb {host}/{bucket}
mc mb local/mybucket

# change bucket policy: mc policy {policy} {host}/{bucket}
mc policy set public local/mybucket

mc policy set download minio_alias/bucketname

$ ./mc.exe policy set download local/turing
Access permission for `local/turing` is set to `download`
```

https://github.com/minio/minio/issues/5180


https://stackoverflow.com/questions/65353889/creating-public-access-to-minio-storage

https://www.cnblogs.com/blogCblog/p/14805044.html


# 多用户权限配置

https://docs.min.io/docs/minio-multi-user-quickstart-guide.html



# OpenID的STS凭证身份认证

两种文件保护方式：一种是多用户方式，每个用户使用单独的 KEY 和 SECRET 上传下载；另外一种则是生成带签名的 URL 给用户上传下载。

多用户方式下，除了创建长期用户，还可以通过 MinIO 提供的 Security Token Service（STS）创建「临时的用户身份」和对应的 KEY 与 SECRET，用户在有效内可以凭此进行文件上传与下载活动。

如果用户使用从 OpenID connect 授权的 STS 凭证进行身份验证，我们允许jwt:*JWT 规范中指定的所有变量，jwt:*不支持自定义或扩展。

基于 OpenID 的 STS 的策略变量列表。

MinIO 提供了三种方式：Client grants、WebIdentity 和 AssumeRole，具体可以看 MinIO STS Quickstart Guide 介绍。

注意：JWT 声明仅适用于 WebIdentity 和 ClientGrants。


https://docs.min.io/docs/minio-sts-quickstart-guide

https://docs.min.io/minio/baremetal/security/minio-identity-management/policy-based-access-control.html

https://docs.min.io/minio/baremetal/security/openid-external-identity-management/configure-openid-external-identity-management.html

https://github.com/minio/minio/issues/6811

https://stevenocean.github.io/2021/01/12/minio-sts-assumerole-sample.html

https://mp.weixin.qq.com/s/rfzHmAWWJKFlEDjCxcb4gw

https://juejin.cn/post/7014354357806170149

## 预签名分段上传

https://docs.min.io/docs/upload-files-from-browser-using-pre-signed-urls.html

https://vsoch.github.io/2020/s3-minio-multipart-presigned-upload/

## STS Assume role 同AWS的 STS(Security Token Service)

```node

/**
   * @summary获取awsminio临时token
   */
  async getMinioToken(){

    const { config, logger, ctx } = this;
    const sts = new AWS.STS({
      accessKeyId: 'admin',
      secretAccessKey: 'password',
      endpoint:'http://127.0.0.1:9000',
      region:'us-east-1'
    });
    console.log("sts=====>",sts)

    const policy = {
      "Version": "2012-10-17",
      "Statement": [
          {
              "Effect": "Allow",
              "Action": [
                "s3:ListAllMyBuckets",
                "s3:ListBucket",
                "s3:GetBucketLocation",
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
              "Resource": ["arn:aws:s3:::*"]
          }
      ]
    }

    const params = {
      ExternalId: "123ABC",
      Policy: JSON.stringify(policy),
      RoleArn: "arn:aws:iam::123456789012:role/demo",   //
      RoleSessionName: "testAssumeRoleSession",
      TransitiveTagKeys: [
         "Project",
         "Cost-Center"
      ]
     };

    sts.assumeRole(params, function (err, data) {
      if (err) console.log(err, err.stack); // an error occurred
      else     console.log(data);           // successful response
    });
  }
```

```go
func (s *TestSuiteIAM) TestSTS(c *check) {
	ctx, cancel := context.WithTimeout(context.Background(), testDefaultTimeout)
	defer cancel()

	bucket := getRandomBucketName()
	err := s.client.MakeBucket(ctx, bucket, minio.MakeBucketOptions{})
	if err != nil {
		c.Fatalf("bucket creat error: %v", err)
	}

	// Create policy, user and associate policy
	policy := "mypolicy"
	policyBytes := []byte(fmt.Sprintf(`{
 "Version": "2012-10-17",
 "Statement": [
  {
   "Effect": "Allow",
   "Action": [
    "s3:PutObject",
    "s3:GetObject",
    "s3:ListBucket"
   ],
   "Resource": [
    "arn:aws:s3:::%s/*"
   ]
  }
 ]
}`, bucket))
	err = s.adm.AddCannedPolicy(ctx, policy, policyBytes)
	if err != nil {
		c.Fatalf("policy add error: %v", err)
	}

	accessKey, secretKey := mustGenerateCredentials(c)
	err = s.adm.SetUser(ctx, accessKey, secretKey, madmin.AccountEnabled)
	if err != nil {
		c.Fatalf("Unable to set user: %v", err)
	}

	err = s.adm.SetPolicy(ctx, policy, accessKey, false)
	if err != nil {
		c.Fatalf("Unable to set policy: %v", err)
	}

	// confirm that the user is able to access the bucket
	uClient := s.getUserClient(c, accessKey, secretKey, "")
	c.mustListObjects(ctx, uClient, bucket)

	assumeRole := cr.STSAssumeRole{
		Client:      s.TestSuiteCommon.client,
		STSEndpoint: s.endPoint,
		Options: cr.STSAssumeRoleOptions{
			AccessKey: accessKey,
			SecretKey: secretKey,
			Location:  "",
		},
	}

	value, err := assumeRole.Retrieve()
	if err != nil {
		c.Fatalf("err calling assumeRole: %v", err)
	}

	minioClient, err := minio.New(s.endpoint, &minio.Options{
		Creds:     cr.NewStaticV4(value.AccessKeyID, value.SecretAccessKey, value.SessionToken),
		Secure:    s.secure,
		Transport: s.TestSuiteCommon.client.Transport,
	})
	if err != nil {
		c.Fatalf("Error initializing client: %v", err)
	}

	// Validate that the client from sts creds can access the bucket.
	c.mustListObjects(ctx, minioClient, bucket)

	// Validate that the client cannot remove any objects
	err = minioClient.RemoveObject(ctx, bucket, "someobject", minio.RemoveObjectOptions{})
	if err.Error() != "Access Denied." {
		c.Fatalf("unexpected non-access-denied err: %v", err)
	}
}

// https://github.com/minio/minio/blob/de400f347390b7825e18ea68b7b3bfa67cee0f59/cmd/sts-handlers_test.go
```

https://github.com/minio/minio/tree/master/docs/sts

https://github.com/minio/minio/blob/master/docs/sts/assume-role.md

https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html#API_AssumeRole_ResponseElements

https://blog.csdn.net/weixin_41092687/article/details/119033925


https://github.com/minio/minio/blob/de400f347390b7825e18ea68b7b3bfa67cee0f59/cmd/sts-handlers_test.go

https://github.com/minio/minio-java/blob/master/examples/MinioClientWithAssumeRoleProvider.java


## access-policy策略详解

```json
{
    "Version": "2012-10-17",
    "Id": "ExamplePolicy01",
    "Statement": [
        {
            "Sid": "ExampleStatement01",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::Account-ID:user/Dave"
            },
            "Action": [
                "s3:GetObject",
                "s3:GetBucketLocation",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::examplebucket/*",
                "arn:aws:s3:::examplebucket"
            ]
        }
    ]
}


curl 'http://192.168.203.130:9001/api/v1/buckets/turing/set-policy' \
  -X 'PUT' \
  -H 'Connection: keep-alive' \
  -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.93 Safari/537.36' \
  -H 'Content-Type: application/json' \
  -H 'Accept: */*' \
  -H 'Origin: http://192.168.203.130:9001' \
  -H 'Referer: http://192.168.203.130:9001/buckets/turing/admin/summary' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
  -H 'Cookie: UM-SSO-BDP=eyJob3N0X3BvcnQiOiIxOTIuMTY4LjIwMy4xMzA6OTUwMyIsIlgtQVVUSC1JRCI6ImFkbWluIiwidGstdGltZSI6IjIwMjExMjEzMjMzNDQ4IiwiYWxnIjoiTUQ1In0%3D%2CeyJ1cGRhdGVUaW1lIjoiMjAyMS0xMi0wOCAxODo0NzowNSIsInVzZXJUeXBlIjoyLCJyb2xlIjoic3VwZXIiLCJjcmVhdGVUaW1lIjoiMjAyMS0xMi0wOCAxODo0NzowNSIsIlgtQVVUSC1JRCI6ImFkbWluIn0%3D%2Cae8aeec780a956a49ea639dd997a8330; token=AJWIQOJVkqXRsan/EeuGY+Kx/wogiIy1KDTPc1N4KKWD46XfSwSXiTNmcDfURB/okH+yIVraL9ROhvl3FuVlN7kPCCCpy4fXEx5+98NarVft1aeeB69PeFL8/Dr8wYI3Urx2Ok0O6K+JRjt3LbBfnAJjqcODaL7i3++1qlc1Nn7wEVNr08eT3XdPUO04wpnyLUWjDVr4JSbo2E2e5uJRA026eThVRYIoSlz57MteuKIhKfPHfaUpKCLx5kHcXIPD1H4S6F0nVokqz8FfIjuSsGM2C0j8M5KL4+DfFiZ+2vgX6h08D6NnrVlPpDeXW7w662aoWwUM5YWG1PQc+ZRKOdO7BrzbIbf5kK7yG2D0MdNQGpVlXOYhhFPNVUK4nIhLWmNRtxDpoxi2KABtJWZbrEWYiZMZbOIj0LNHU9iwz9pN0oxZG9Z4ZpqFIGYPKpzjWcPoDN0LzFirwu6kZEi40VrgaZBOmAaF4BLTmKh0VRV1NQr7/XdRHnkXUvVjxjirI+M36dCcnJZF8oIorgQcztzcjzt+Ok1pfQobvK/2pSoo3iItANGTPZE=' \
  --data-raw '{"access":"PRIVATE"}' \
  --compressed \
  --insecure
```

https://github.com/minio/minio-js/issues/699

https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.html

https://docs.min.io/docs/minio-client-complete-guide#policy

https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-arn-format.html

https://github.com/minio/minio-js/issues/699



# 命令

sql，支持在 csv 格式的文件上进行 SQL 查询

```sh
[health@kyc-dev bin]$ ./mc sql --help
NAME:
  mc sql - run sql queries on objects

USAGE:
  mc sql [FLAGS] TARGET [TARGET...]

FLAGS:
  --query value, -e value       sql query expression (default: "select * from s3object")
  --recursive, -r               sql query recursively
  --csv-input value             csv input serialization option
  --json-input value            json input serialization option
  --compression value           input compression type
  --csv-output value            csv output serialization option
  --csv-output-header value     optional csv output header
  --json-output value           json output serialization option
  --encrypt-key value           encrypt/decrypt objects (using server-side encryption with customer provided keys)
  --config-dir value, -C value  path to configuration folder (default: "/home/health/.mc")
  --quiet, -q                   disable progress bar display
  --no-color                    disable color theme
  --json                        enable JSON lines formatted output
  --debug                       enable debug output
  --insecure                    disable SSL certificate verification
  --help, -h                    show help

ENVIRONMENT VARIABLES:
  MC_ENCRYPT_KEY: list of comma delimited prefix=secret values

SERIALIZATION OPTIONS:
  For query serialization options, refer to https://docs.min.io/docs/minio-client-complete-guide#sql

EXAMPLES:
  1. Run a query on a set of objects recursively on AWS S3.
     $ mc sql --recursive --query "select * from S3Object" s3/personalbucket/my-large-csvs/

  2. Run a query on an object on MinIO.
     $ mc sql --query "select count(s.power) from S3Object" myminio/iot-devices/power-ratio.csv

  3. Run a query on an encrypted object with customer provided keys.
     $ mc sql --encrypt-key "myminio/iot-devices=32byteslongsecretkeymustbegiven1" \
           --query "select count(s.power) from S3Object s" myminio/iot-devices/power-ratio-encrypted.csv

  4. Run a query on an object on MinIO in gzip format using ; as field delimiter,
     newline as record delimiter and file header to be used
     $ mc sql --compression GZIP --csv-input "rd=\n,fh=USE,fd=;" \
           --query "select count(s.power) from S3Object" myminio/iot-devices/power-ratio.csv.gz

  5. Run a query on an object on MinIO in gzip format using ; as field delimiter,
     newline as record delimiter and file header to be used
     $ mc sql --compression GZIP --csv-input "rd=\n,fh=USE,fd=;" \
           --json-output "rd=\n\n" --query "select * from S3Object" myminio/iot-devices/data.csv

  6. Run same query as in 5., but specify csv output headers. If --csv-output-headers is
     specified as "", first row of csv is interpreted as header
     $ mc sql --compression GZIP --csv-input "rd=\n,fh=USE,fd=;" \
           --csv-output "rd=\n" --csv-output-header "device_id,uptime,lat,lon" \
           --query "select * from S3Object" myminio/iot-devices/data.csv
```
