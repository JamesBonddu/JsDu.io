

# swagger 地址

A：1， 3.1.0+ 版本地址是 http://apiServerIp:apiServerPort/dolphinscheduler/swagger-ui/index.html, 1.2+ 版本地址是：http://apiServerIp:apiServerPort/dolphinscheduler/swagger-ui/index.html?language=zh_CN&lang=cn，其它版本是 http://apiServerIp:apiServerPort/escheduler/swagger-ui/index.html?language=zh_CN&lang=cn。


```java
src/main/java/org/apache/dolphinscheduler/plugin/datasource/api/utils/DataSourceUtils.java
// 展示表结构
getTables(Integer datasourceId)

// 获取表中的字段列
getTableColumns(Integer datasourceId,String tableName)

  Result result = new Result();
        IPage<DataSource> dataSourceList = null;
        Page<DataSource> dataSourcePage = new Page<>(pageNo, pageSize);
        PageInfo<DataSource> pageInfo = new PageInfo<>(pageNo, pageSize);
        if (loginUser.getUserType().equals(UserType.ADMIN_USER)) {
            dataSourceList = dataSourceMapper.selectPaging(dataSourcePage, UserType.ADMIN_USER.equals(loginUser.getUserType()) ? 0 : loginUser.getId(), searchVal);
        } else {
            Set<Integer> ids = resourcePermissionCheckService.userOwnedResourceIdsAcquisition(AuthorizationType.DATASOURCE, loginUser.getId(), logger);
            if (ids.isEmpty()) {
                result.setData(pageInfo);
                putMsg(result, Status.SUCCESS);
                return result;
            }
            dataSourceList = dataSourceMapper.selectPagingByIds(dataSourcePage, new ArrayList<>(ids), searchVal);
        }

        List<DataSource> dataSources = dataSourceList != null ? dataSourceList.getRecords() : new ArrayList<>();
        handlePasswd(dataSources);
        pageInfo.setTotal((int) (dataSourceList != null ? dataSourceList.getTotal() : 0L));
        pageInfo.setTotalList(dataSources);
        result.setData(pageInfo);
        putMsg(result, Status.SUCCESS);
        return result;
```


新增CSV/TXT数据源

```java
"CSVConnectionParam{"
+ "other='" + other + '\''
+ '}';

// csv 参数other格式
{
 "url": urlfpath,
 "encoding": "UTF-8",
 "fieldDelimiter": ",",
 "name": "名称"
}
```

前端界面通过自定义json字段
```js
if (data.taskType === 'DATAX') {
    taskParams.customConfig = data.customConfig ? 1 : 0
    if (taskParams.customConfig === 0) {
        taskParams.dsType = data.dsType
        taskParams.dataSource = data.dataSource
        taskParams.dtType = data.dtType
        taskParams.dataTarget = data.dataTarget
        taskParams.sql = data.sql
        taskParams.targetTable = data.targetTable
        taskParams.jobSpeedByte = data.jobSpeedByte
        taskParams.jobSpeedRecord = data.jobSpeedRecord
        taskParams.preStatements = data.preStatements
        taskParams.postStatements = data.postStatements
    } else {
        taskParams.json = data.json
        data?.localParams?.map((param: ILocalParam) => {
        param.direct = 'IN'
        param.type = 'VARCHAR'
        })
    }
    taskParams.xms = data.xms
    taskParams.xmx = data.xmx
}
```

定义流程

```java
// process-definition
curl 'http://127.0.0.1:5173/dolphinscheduler/projects/7562259384832/process-definition/7573841218560' \
  -X 'PUT' \
  -H 'Accept: application/json, text/plain, */*' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7' \
  -H 'Cache-Control: no-cache' \
  -H 'Connection: keep-alive' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Cookie: securityConfigType=PASSWORD; sessionId=fe015cac-2eeb-4811-a96b-8c50535f1b19; language=zh_CN; sessionId=fe015cac-2eeb-4811-a96b-8c50535f1b19' \
  -H 'Origin: http://127.0.0.1:5173' \
  -H 'Pragma: no-cache' \
  -H 'Referer: http://127.0.0.1:5173/projects/7562259384832/workflow/definitions/7573841218560' \
  -H 'Sec-Fetch-Dest: empty' \
  -H 'Sec-Fetch-Mode: cors' \
  -H 'Sec-Fetch-Site: same-origin' \
  -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36' \
  -H 'language: zh_CN' \
  -H 'sec-ch-ua: "Google Chrome";v="107", "Chromium";v="107", "Not=A?Brand";v="24"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "Windows"' \
  -H 'sessionId: fe015cac-2eeb-4811-a96b-8c50535f1b19' \
  --data-raw 'taskDefinitionJson=%5B%7B%22id%22%3A8%2C%22code%22%3A7573635880576%2C%22name%22%3A%22datax-test3%22%2C%22version%22%3A1%2C%22description%22%3A%22datax-test3%22%2C%22projectCode%22%3A7562259384832%2C%22userId%22%3A1%2C%22taskType%22%3A%22DATAX%22%2C%22taskParams%22%3A%7B%22localParams%22%3A%5B%5D%2C%22resourceList%22%3A%5B%5D%2C%22customConfig%22%3A0%2C%22dsType%22%3A%22MYSQL%22%2C%22dataSource%22%3A1%2C%22dtType%22%3A%22MYSQL%22%2C%22dataTarget%22%3A1%2C%22sql%22%3A%22select%20park_name%2C%20carrier_category%2Cname%2C%20area%20from%20carrier%22%2C%22targetTable%22%3A%22target_carrier%22%2C%22jobSpeedByte%22%3A0%2C%22jobSpeedRecord%22%3A1000%2C%22preStatements%22%3A%5B%22truncate%20table%20target_carrier%22%5D%2C%22postStatements%22%3A%5B%5D%2C%22xms%22%3A1%2C%22xmx%22%3A1%7D%2C%22taskParamList%22%3A%5B%5D%2C%22taskParamMap%22%3Anull%2C%22flag%22%3A%22YES%22%2C%22taskPriority%22%3A%22MEDIUM%22%2C%22userName%22%3Anull%2C%22projectName%22%3Anull%2C%22workerGroup%22%3A%22default%22%2C%22environmentCode%22%3A-1%2C%22failRetryTimes%22%3A0%2C%22failRetryInterval%22%3A1%2C%22timeoutFlag%22%3A%22CLOSE%22%2C%22timeoutNotifyStrategy%22%3A%22WARN%22%2C%22timeout%22%3A0%2C%22delayTime%22%3A0%2C%22resourceIds%22%3A%22%22%2C%22createTime%22%3A%222022-11-16%2020%3A17%3A09%22%2C%22updateTime%22%3A%222022-11-16%2020%3A17%3A09%22%2C%22modifyBy%22%3Anull%2C%22taskGroupId%22%3A0%2C%22taskGroupPriority%22%3A0%2C%22cpuQuota%22%3A-1%2C%22memoryMax%22%3A-1%2C%22taskExecuteType%22%3A%22BATCH%22%2C%22operator%22%3A1%2C%22operateTime%22%3A%222022-11-16%2020%3A17%3A09%22%2C%22dependence%22%3A%22%22%7D%2C%7B%22id%22%3A9%2C%22code%22%3A7584910158464%2C%22name%22%3A%22DQC%22%2C%22version%22%3A1%2C%22description%22%3A%22DQC%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%22%2C%22projectCode%22%3A7562259384832%2C%22userId%22%3A1%2C%22taskType%22%3A%22DATA_QUALITY%22%2C%22taskParams%22%3A%7B%22localParams%22%3A%5B%5D%2C%22resourceList%22%3A%5B%5D%2C%22ruleId%22%3A1%2C%22ruleInputParameter%22%3A%7B%22check_type%22%3A%220%22%2C%22failure_strategy%22%3A%220%22%2C%22operator%22%3A%220%22%2C%22src_connector_type%22%3A0%2C%22src_datasource_id%22%3A1%2C%22src_field%22%3Anull%2C%22src_table%22%3A%22ads_category%22%2C%22threshold%22%3A%223%22%7D%2C%22sparkParameters%22%3A%7B%22deployMode%22%3A%22local%22%2C%22driverCores%22%3A1%2C%22driverMemory%22%3A%22512M%22%2C%22executorCores%22%3A2%2C%22executorMemory%22%3A%222G%22%2C%22numExecutors%22%3A2%2C%22others%22%3A%22--conf%20spark.yarn.maxAppAttempts%3D1%22%7D%7D%2C%22taskParamList%22%3A%5B%5D%2C%22taskParamMap%22%3Anull%2C%22flag%22%3A%22YES%22%2C%22taskPriority%22%3A%22MEDIUM%22%2C%22userName%22%3Anull%2C%22projectName%22%3Anull%2C%22workerGroup%22%3A%22default%22%2C%22environmentCode%22%3A-1%2C%22failRetryTimes%22%3A0%2C%22failRetryInterval%22%3A1%2C%22timeoutFlag%22%3A%22CLOSE%22%2C%22timeoutNotifyStrategy%22%3A%22WARN%22%2C%22timeout%22%3A0%2C%22delayTime%22%3A0%2C%22resourceIds%22%3A%22%22%2C%22createTime%22%3A%222022-11-17%2020%3A19%3A41%22%2C%22updateTime%22%3A%222022-11-17%2020%3A19%3A41%22%2C%22modifyBy%22%3Anull%2C%22taskGroupId%22%3A0%2C%22taskGroupPriority%22%3A0%2C%22cpuQuota%22%3A-1%2C%22memoryMax%22%3A-1%2C%22taskExecuteType%22%3A%22BATCH%22%2C%22operator%22%3A1%2C%22operateTime%22%3A%222022-11-17%2020%3A19%3A41%22%2C%22dependence%22%3A%22%22%7D%5D&taskRelationJson=%5B%7B%22name%22%3A%22%22%2C%22preTaskCode%22%3A0%2C%22preTaskVersion%22%3A0%2C%22postTaskCode%22%3A7573635880576%2C%22postTaskVersion%22%3A1%2C%22conditionType%22%3A%22NONE%22%2C%22conditionParams%22%3A%7B%7D%7D%2C%7B%22name%22%3A%22%22%2C%22preTaskCode%22%3A0%2C%22preTaskVersion%22%3A0%2C%22postTaskCode%22%3A7584910158464%2C%22postTaskVersion%22%3A1%2C%22conditionType%22%3A%22NONE%22%2C%22conditionParams%22%3A%7B%7D%7D%5D&locations=%5B%7B%22taskCode%22%3A7573635880576%2C%22x%22%3A352%2C%22y%22%3A284%7D%2C%7B%22taskCode%22%3A7584910158464%2C%22x%22%3A593%2C%22y%22%3A367%7D%5D&name=datax-test3-workflow3&tenantCode=JSDu&executionType=PARALLEL&description=datax-test3-workflow3&globalParams=%5B%5D&timeout=0&releaseState=OFFLINE' \
  --compressed
```
```json
[{"id":8,"code":7573635880576,"name":"datax-test3","version":1,"description":"datax-test3","projectCode":7562259384832,"userId":1,"taskType":"DATAX","taskParams":{"localParams":[],"resourceList":[],"customConfig":0,"dsType":"MYSQL","dataSource":1,"dtType":"MYSQL","dataTarget":1,"sql":"select park_name, carrier_category,name, area from carrier","targetTable":"target_carrier","jobSpeedByte":0,"jobSpeedRecord":1000,"preStatements":["truncate table target_carrier"],"postStatements":[],"xms":1,"xmx":1},"taskParamList":[],"taskParamMap":null,"flag":"YES","taskPriority":"MEDIUM","userName":null,"projectName":null,"workerGroup":"default","environmentCode":-1,"failRetryTimes":0,"failRetryInterval":1,"timeoutFlag":"CLOSE","timeoutNotifyStrategy":"WARN","timeout":0,"delayTime":0,"resourceIds":"","createTime":"2022-11-16 20:17:09","updateTime":"2022-11-16 20:17:09","modifyBy":null,"taskGroupId":0,"taskGroupPriority":0,"cpuQuota":-1,"memoryMax":-1,"taskExecuteType":"BATCH","operator":1,"operateTime":"2022-11-16 20:17:09","dependence":""},{"id":9,"code":7584910158464,"name":"DQC","version":1,"description":"DQC数据质量","projectCode":7562259384832,"userId":1,"taskType":"DATA_QUALITY","taskParams":{"localParams":[],"resourceList":[],"ruleId":1,"ruleInputParameter":{"check_type":"0","failure_strategy":"0","operator":"0","src_connector_type":0,"src_datasource_id":1,"src_field":null,"src_table":"ads_category","threshold":"3"},"sparkParameters":{"deployMode":"local","driverCores":1,"driverMemory":"512M","executorCores":2,"executorMemory":"2G","numExecutors":2,"others":"--conf spark.yarn.maxAppAttempts=1"}},"taskParamList":[],"taskParamMap":null,"flag":"YES","taskPriority":"MEDIUM","userName":null,"projectName":null,"workerGroup":"default","environmentCode":-1,"failRetryTimes":0,"failRetryInterval":1,"timeoutFlag":"CLOSE","timeoutNotifyStrategy":"WARN","timeout":0,"delayTime":0,"resourceIds":"","createTime":"2022-11-17 20:19:41","updateTime":"2022-11-17 20:19:41","modifyBy":null,"taskGroupId":0,"taskGroupPriority":0,"cpuQuota":-1,"memoryMax":-1,"taskExecuteType":"BATCH","operator":1,"operateTime":"2022-11-17 20:19:41","dependence":""}]
```

流程定义核心有
- taskDefinitionJson
- taskRelationJson
- locations:  [{"taskCode":7573635880576,"x":352,"y":284},{"taskCode":7584910158464,"x":593,"y":367}]
- name: datax-test3-workflow3
- tenantCode: JSDu
- executionType: PARALLEL
- description: datax-test3-workflow3
- globalParams: []
- timeout: 0
- releaseState: OFFLINE



`t_ds_task_definition` 里面的 `task_params` 字段存储的json是这种格式.

```json
{"localParams":[],"resourceList":[],"customConfig":0,"dsType":"MYSQL","dataSource":1,"dtType":"MYSQL","dataTarget":1,"sql":"select park_name, carrier_category,name, area from carrier","targetTable":"target_carrier","jobSpeedByte":0,"jobSpeedRecord":1000,"preStatements":["truncate table target_carrier"],"postStatements":[],"xms":1,"xmx":1}
```

csv格式的数据需要在task_definition的时候将数据拼装好放到task_params
```java
// 设置customConfig=1
// 将csv格式的CSVConnectionParam转换为 json状态.

```

```java
// src/main/java/org/apache/dolphinscheduler/server/worker/runner/WorkerTaskExecuteRunnable.java
protected void beforeExecute() {
    task = taskChannel.createTask(taskExecutionContext);
}
```

*TaskChannel*  获取到传递给datax的任务.

```java
public class DataxTaskChannel implements TaskChannel {

    @Override
    public void cancelApplication(boolean status) {

    }

    @Override
    public AbstractTask createTask(TaskExecutionContext taskRequest) {
        return new DataxTask(taskRequest);
    }

    @Override
    public AbstractParameters parseParameters(ParametersNode parametersNode) {
        return JSONUtils.parseObject(parametersNode.getTaskParams(), DataxParameters.class);
    }

    @Override
    public ResourceParametersHelper getResources(String parameters) {
        return JSONUtils.parseObject(parameters, DataxParameters.class).getResources();
    }
}
```


在 *buildDataxJsonFile* 调用之前将customconfig设置为1, 同时设置json为自定义的json.
```java
public void handle(TaskCallBack taskCallBack) throws TaskException {
    try {
        // replace placeholder,and combine local and global parameters
        Map<String, Property> paramsMap = taskExecutionContext.getPrepareParamsMap();

        // run datax processDataSourceService
        String jsonFilePath = buildDataxJsonFile(paramsMap);
    }
```

```java
DataxParameters dataxParameters = new DataxParameters();
dataxParameters.setCustomConfig(1);
dataxParameters.setDsType("mysql");
dataxParameters.setDataSource(1);
dataxParameters.setJson(getJsonString());
dataxParameters.setDataTarget(2);
dataxParameters.setSql("SELECT count(*) FROM table");
dataxParameters.setTargetTable("user.name");
return dataxParameters;
```
